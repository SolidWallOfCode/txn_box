meta:
  version: "1.0"

  txn-box:
  - when: ua-req
    do:
    - with: ua-req-query
      select:
      - rxp<nc>: "^emailaddress=[^&;]*[;&]?(.*)$" # first value.
        do:
        - ua-req-query: "{1}"
      - rxp<nc>: "(.*?)[&;]emailaddress=[^&;]*(.*)$" # not first value
        do:
        - ua-req-query: "{1}{2}"

  blocks:
  - base-req: &base-req
      version: "1.1"
      method: "GET"
  - base-rsp: &base-rsp
      status: 200
      reason: OK
      headers:
        fields:
        - [ Content-Type, html/plaintext ]
        - [ Content-Length, 96 ]

sessions:
- protocol: [ { name: ip, version : 4} ]
  transactions:

  # No query
  - all: { headers: { fields: [[ uuid, no-query ]]}}
    client-request:
      <<: *base-req
      url: "/page.html"
      headers:
        fields:
        - [ Host, one.ex ]
    proxy-request:
      <<: *base-req
      url:
      - [ query, { as: absent } ]
    server-response:
      <<: *base-rsp
    proxy-response:
      status: 200

  # No match on query.
  - all: { headers: { fields: [[ uuid, not-present ]]}}
    client-request:
      <<: *base-req
      url: "/page.html?Delain=best"
      headers:
        fields:
        - [ Host, one.ex ]
    proxy-request:
      <<: *base-req
      url:
      - [ query, { value: "Delain=best", as: "equal" } ]
    server-response:
      <<: *base-rsp
    proxy-response:
      status: 200

  # Remove single value.
  - all: { headers: { fields: [[ uuid, delete-one ]]}}
    client-request:
      <<: *base-req
      url: "/page.html?emailAddress=solidwallofcode@verizonmedia.com"
      headers:
        fields:
        - [ Host, one.ex ]
    proxy-request:
      <<: *base-req
      url:
      - [ query, { as: absent } ]
    server-response:
      <<: *base-rsp
    proxy-response:
      status: 200

  # Delete first of two
  - all: { headers: { fields: [[ uuid, delete-first-of-two ]]}}
    client-request:
      <<: *base-req
      url: "/page.html?emailaddress=me@nowhere.com&delain=best"
      headers:
        fields:
        - [ Host, three.ex ]
    proxy-request:
      <<: *base-req
      url:
      - [ query, { value: "delain=best", as: "equal" } ]
    server-response:
      <<: *base-rsp
    proxy-response:
      status: 200

  # Delete last of two
  - all: { headers: { fields: [[ uuid, delete-last-two ]]}}
    client-request:
      <<: *base-req
      url: "/page.html?emailaddress=me@nowhere.com&delain=best"
      headers:
        fields:
        - [ Host, three.ex ]
    proxy-request:
      <<: *base-req
      url:
      - [ query, { value: "delain=best", as: "equal" } ]
    server-response:
      <<: *base-rsp
    proxy-response:
      status: 200

  # Delete last of four
  - all: { headers: { fields: [[ uuid, delete-last-four ]]}}
    client-request:
      <<: *base-req
      url: "/page.html?xandria=nice&leah=cool&nightwish=good&EmailAddress=alpha@bravo.com"
      headers:
        fields:
        - [ Host, three.ex ]
    proxy-request:
      <<: *base-req
      url:
      - [ query, { value: "xandria=nice&leah=cool&nightwish=good", as: "equal" } ]
    server-response:
      <<: *base-rsp
    proxy-response:
      status: 200

  # Delete first of four
  - all: { headers: { fields: [[ uuid, delete-first-four ]]}}
    client-request:
      <<: *base-req
      url: "/page.html?EmailAddress=alpha@bravo.com&xandria=nice&leah=cool&nightwish=good"
      headers:
        fields:
        - [ Host, three.ex ]
    proxy-request:
      <<: *base-req
      url:
      - [ query, { value: "xandria=nice&leah=cool&nightwish=good", as: "equal" } ]
    server-response:
      <<: *base-rsp
    proxy-response:
      status: 200

  # Delete middle of four
  - all: { headers: { fields: [[ uuid, delete-middle-four ]]}}
    client-request:
      <<: *base-req
      url: "/page.html?xandria=nice&EmailAddress=alpha@bravo.com&leah=cool&nightwish=good"
      headers:
        fields:
        - [ Host, three.ex ]
    proxy-request:
      <<: *base-req
      url:
      - [ query, { value: "xandria=nice&leah=cool&nightwish=good", as: "equal" } ]
    server-response:
      <<: *base-rsp
    proxy-response:
      status: 200

